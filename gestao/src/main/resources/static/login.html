<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Login - Oficina Mecânica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); height: 100vh; display: flex; align-items: center; }
        .login-card { border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="card login-card border-0">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h2 class="fw-bold text-primary">SGOM</h2>
                            <p class="text-muted">Gestão de Oficina</p>
                        </div>
                        <form id="formLogin">
                            <div class="mb-3">
                                <label class="form-label">E-mail</label>
                                <input type="email" id="email" class="form-control" placeholder="exemplo@email.com" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Senha</label>
                                <input type="password" id="senha" class="form-control" placeholder="******" required>
                            </div>
                            <button type="submit" id="btnEntrar" class="btn btn-primary w-100 py-2">Entrar</button>
                        </form>
                        <div class="mt-3 text-center">
                            <small>Não tem conta? <a href="cadastro.html" class="text-decoration-none">Cadastre-se</a></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btnEntrar');
            btn.disabled = true;
            btn.innerText = "Verificando...";

            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            // Criando o Header de Autenticação Básica (Base64)
            const authHeader = 'Basic ' + btoa(email + ':' + senha);

            try {
                const response = await fetch('/api/usuarios/me', {
                    method: 'GET',
                    headers: { 
                        'Authorization': authHeader,
                        // Este header avisa o Spring para NÃO abrir a janelinha de login do navegador
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                });

                if (response.ok) {
                    const usuario = await response.json();
                    
                    // Salva dados no navegador
                    localStorage.setItem('auth', authHeader);
                    localStorage.setItem('user_tipo', usuario.tipo);
                    localStorage.setItem('user_nome', usuario.nome);

                    // Redirecionamento baseado no TipoUsuario (Enum)
                    const destinos = {
                        'ADMINISTRADOR': 'dashboard_admin.html',
                        'FUNCIONARIO': 'dashboard_funcionario.html',
                        'CLIENTE': 'minha_area_cliente.html'
                    };

                    window.location.href = destinos[usuario.tipo] || 'index.html';
                    
                } else if (response.status === 401) {
                    alert("E-mail ou senha incorretos.");
                } else {
                    alert("Erro no servidor. Tente novamente mais tarde.");
                }
            } catch (error) {
                console.error("Erro no login:", error);
                alert("Não foi possível conectar ao servidor. Verifique se o Backend está rodando.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Entrar";
            }
        });
    </script>
</body>
</html>